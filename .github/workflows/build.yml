name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Inject API Key
      run: |
        $configPath = "HyTaLauncher\Config.cs"
        $content = Get-Content $configPath -Raw
        $content = $content -replace '#{CURSEFORGE_API_KEY}#', '${{ secrets.CURSEFORGE_API_KEY }}'
        Set-Content $configPath $content
      shell: pwsh
    
    - name: Build Portable
      run: |
        dotnet publish HyTaLauncher -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true
    
    - name: Create Portable Package
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        $publishDir = "HyTaLauncher\bin\Release\net8.0-windows\win-x64\publish"
        $portableDir = "portable"
        
        New-Item -ItemType Directory -Path $portableDir | Out-Null
        Copy-Item "$publishDir\HyTaLauncher.exe" $portableDir
        Copy-Item -Recurse "HyTaLauncher\Fonts" "$portableDir\Fonts"
        Copy-Item -Recurse "HyTaLauncher\Languages" "$portableDir\Languages"
        
        Compress-Archive -Path "$portableDir\*" -DestinationPath "HyTaLauncher_Portable_$version.zip"
      shell: pwsh
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: HyTaLauncher-Portable
        path: HyTaLauncher_Portable_*.zip
    
    # - name: Create Release
    #   if: startsWith(github.ref, 'refs/tags/')
    #   uses: softprops/action-gh-release@v1
    #   with:
    #     files: HyTaLauncher_Portable_*.zip
    #     draft: true
    #     prerelease: false
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
